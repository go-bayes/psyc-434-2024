{
  "hash": "adf58d7c7936837621d49ccfc3f22000",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Causal Inference: Estimation of ATE and CATE\"\ndate: \"2023-APR-28\"\nformat:\n  html:\n    warnings: FALSE\n    error: FALSE\n    messages: FALSE\n    code-overflow: scroll\n    highlight-style: oblivion\n    code-tools:\n      source: true\n      toggle: FALSE\nhtml-math-method: katex\nreference-location: margin\ncitation-location: margin\ncap-location: margin\ncode-block-border-left: true\n---\n\n\n\n\n\n\n::: {.callout-note}\n**Required**\n- [@vanderweele2020] [link](https://www.dropbox.com/scl/fi/srpynr0dvjcndveplcydn/OutcomeWide_StatisticalScience.pdf?rlkey=h4fv32oyjegdfl3jq9u1fifc3&dl=0)\n\n\n**Optional**\n- [@suzuki2020] [link](https://www.dropbox.com/scl/fi/4midxwr9ltg9oce02e0ss/suzuki-causal-diagrams.pdf?rlkey=uktzf3nurtgpbj8m4h0xz82dn&dl=0)\n- [@Bulbulia2024PracticalGuide] [link](https://osf.io/preprints/psyarxiv/uyg3d)\n- [@hoffman2023] [link](https://arxiv.org/pdf/2304.09460.pdf)\n:::\n\n::: {.callout-important}\n## Key concepts for the test(s):\n  - **Counfounding vs Confounder**\n  - **Causal Estimand, Statistical Estimand, Statistical Estimator**\n  - **Inverse probabilitiy of treatment weights using propensity scores: modelling the exposure or treatment, not the outcome.**\n  - **Subgroup analysis using propensity scores**\n:::\n\n::: {.callout-important}\n## For the lab, copy and paste code chunks following the \"LAB\" section.\n:::\n\n\n# Seminar\n\n## Learning Outcomes\n\n- You will learn how to state a causal question in a three-wave panel\n- You will learn how to identify causal effects in a three-waves of panel data.\n- How to do Propensity-score weighting: modelling the exposure or treatment, not the outcome.\n<!-- - Outcome modelling: modelling the outcome, with the treatment included in the model -->\n<!-- - Doubly robust estimation: model both the treatment and the outcome.** -->\n- Subgroup analysis by doubly-robust estimation\n\n\n<!-- - You will learn how to write a report statement that formulates a causal question, names a population of interest, and constructs a causal diagram that explains whether and how to identify a causal effect from data.  -->\n\n\n### Why is this lesson important?\n\n<!-- Recall that in psychology, our task is to answer some questions about how people think and behave. In cross-cultural psychology, these questions are typically comparative. -->\n\n<!-- Our first task is clearly define that question. Our second task is to answer that question. -->\n\nThe methods you will learn today will help you to define and answer comparative questions in psychology. \n\n\n## Review: The Fundamental Problem of Causal Inference as a Missing Data Problem\n\nRecall the fundamental problem of causal inference, returning to the question of whether bilingualism improves cognitive abilities:\n\n-   $Y_i^{a = 1}$: The cognitive ability of child $i$ if they were bilingual. This is the counterfactual outcome when A = 1.\n-   $Y_i^{a = 0}$:: The cognitive ability of child $i$ if they were monolingual. This is the counterfactual outcome when A = 0.\n\nThe causal effect of bilingualism on cognitive ability for individual $i$ is then defined as the difference between these potential outcomes:\n\n$$\n\\text{Causal Effect}_i = Y^{a=1} - Y^{a=0} \n$$\n\nWe say there is a causal effect if:\n\n$$\nY^{a=1} - Y^{a=0}  \\neq 0\n$$\n\nHowever, we only observe one of the potential outcomes for each child. The other outcome is not observed because physics prevents a child from both receiving and not receiving bilingual exposure.\n\nThe fact that causal contrasts are not observed in individuals is called \"The fundamental problem of causal inference.\"\n\nAlthough we typically cannot observe individual causal effects, we can obtain average causal effects when certain assumptions are satisfied.\n\n\n\n```{=tex}\n\\begin{align}\nE(\\delta) = E(Y^{a=1} - Y^{a=0})\\\\\n          ~  = E(Y^{a=1}) - E(Y^{a=0}) \\\\\n          ~  = ATE\n\\end{align}\n```\n\n\nWe may identify average causal effects from the data when the following assumptions are met:\n\n-   **Causal Consistency:** The exposure values under comparisons correspond to well-defined interventions that, in turn, correspond to the treatment versions in the data.[]\n-   **Positivity:** The probability of receiving every value of the exposure within all strata of co-variates is greater than zero []\n-   **Exchangeability:** The conditional probability of receiving every value of an exposure level, though not decided by the investigators, depends only on the measured covariates []\n\nFurther assumptions:\n\n-   **No Interference,** also known as the **Stable Unit Treatment Value Assumption** (SUTVA), requires that the treatment given to one unit (e.g., person, group, organization) does not interfere with the potential outcomes of another unit. Put differently, there are no \"spillover\" effects. Note: this assumption may be thought to be part of causal consistency, namely individual has only one potential outcome under each treatment condition.\n-   **Correctly specified model**: the requirement that the underlying statistical model used to estimate causal effects accurately represents the true relationships between the variables of interest. We say the model should be able to capture \"the functional form\" of the relationship between the treatment, the outcome, and any covariates. The model's functional form should be flexible enough to capture the true underlying relationship. The estimated causal effects may be biased if the model's functional form is incorrect. Additionally, the model must handle omitted variable bias by including all relevant confounders and should correctly handle missing data from non-response or loss-to follow up. We will return to the bias arising from missing data in the weeks ahead. For now, it is important to note that causal inference assumes that our model is correctly specified.\n\n\n## Subgroup analysis\n\n<!-- In causal inference, these two concepts are related but have distinct meanings. -->\n\n<!-- Let $Y_{a}$ denote the counterfactual outcome Y when the experimental intervention $A$ is set to level $a$. Let $Y_{r}$ denote the counterfactual outcome $Y$ when another experimental intervention $R$ is set to level $r$. Following VanderWeele (2009), we can define interaction and effect modification as follows: -->\n\n<!-- 1.  Interaction (causal interaction) on the difference scale, conditional on confounders $L$, occurs when: -->\n\n<!-- $$E(Y^{a1,r1}|L=l) - E(Y^{a0,r1}|L=l) \\neq E(Y^{a1,r0}|L=l) - E(Y^{a0,r0}|L=l)$$ -->\n\n<!-- In this case, we are considering a double intervention, and interaction occurs when the combined effect of interventions $A$ and $R$ is not equal to the sum of their individual effects. -->\n\nRedcall, **Effect Modification** (also known as \"heterogeneity of treatment effects\", and \"Effect-measure modification\") occurs when the causal effect of intervention $A$ varies across different levels of another variable $R$:\n\n$$E(Y^{a=1}|G=g_1, L=l) - E(Y^{a=0}|G=g_1, L=l) \\neq E(Y^{a=1}|G=g_2, L=l) - E(Y^{a=0}|G=g_2, L=l)$$\n\nEffect modification indicates that the magnitude of the causal effect of intervention $A$ is related to the modifier variable $G$ level. As discussed last week, effect modification can be observed even when there is no direct causal interaction between the treatment and the modifier variable. We noted that **interaction in causal inference refers to a situation where the combined effect of two interventions is not equal to the sum of their individual effects**. **Effect modification, on the other hand, occurs when the causal effect of one intervention varies across different levels of another variable.**\n\n\nWe also noted that \n\n> **For comparative research, we are typically interested in effect-modification, which requires subgroup analysis.**\n\n\n### Causal Estimand, Statistical Estimand, Statistical Estimator\n\nLet's set subgroup analysis to the side for a moment and begin focussing on statistical estimation.  \n\nSuppose a researcher wants to understand the causal effect of marriage on individual happiness. Participants in the study are surveyed for their marital status (\"married\" or \"not married\") and their self-reported happiness on a scale from 1 to 10.\n\n#### Causal Estimand\n\n- **Definition**: The causal estimand is the specific quantity or parameter that we aim to estimate to understand the causal effect of an intervention or treatment on an outcome.\n\n- **Example**: Here, the **Causal Estimand** would be the Average Treatment Effect (ATE) of being married on happiness. Specifically, we define the ATE as the difference in the potential outcomes of happiness if all individuals were married versus if no individuals were married:\n\n  $$\n  \\text{ATE} = E[Y^{a=1} - Y^{a=0}]\n  $$\n\n\n  Here, $Y^{a=1}$ represents the potential happiness score if an individual is married, and $Y^{a=0}$ if they are not married.\n\n\n#### Next step: Are Causal Assumptions Met? \n\n- Identification (Exchangeability): balance in the confounders across the treatments to be compared\n\n- Consistency: well-defined interventions\n\n- Positivity: treatments occur within levels of covariates $L$\n\n\n#### Statistical Estimand (next step)\n\n- **The problem**: how do we bridge the gap between potential outcomes and data? \n\n- **Definition**: the statistical estimand is the parameter or function that summarises the relationship between variables as described by a statistical model applied to data. \n\n- **Example**: for our study, the **Statistical Estimand** might be the mean difference in happiness scores between individuals who are married and those who are not, as derived from a linear regression model:\n\n  $$\n  \\text{Happiness} = \\beta_0 + \\beta_1 \\times \\text{Married} + \\epsilon\n  $$\n\n  In this equation, $\\beta_1$ represents the estimated difference in happiness scores between the married and non-married groups.\n\n#### Statistical Estimator\n\n- **Definition**: a statistical estimator is a rule or method by which a numerical estimate of a statistical estimand is calculated from the data.\n\n- **Example**: in our marriage study, the **Statistical Estimator** for $\\beta_1$ is the ordinary least squares (OLS) estimator. This estimator is used to calculate $\\beta_1$ from the sample data provided by the survey. It provides an estimate of the impact of being married on happiness, calculated using:\n  $$\n  \\hat{\\beta}_1 = \\frac{\\sum_{i=1}^n (X_i - \\bar{X})(Y_i - \\bar{Y})}{\\sum_{i=1}^n (X_i - \\bar{X})^2}\n  $$\n  where $X_i$ is a binary indicator for being married (1 for married, 0 for not married), $Y_i$ is the observed happiness score, and $\\bar{X}$, $\\bar{Y}$ are the sample means of $X$ and $Y$, respectively.\n\n\n(Note: you will not need to know this equation for the quiz)\n\n\nThe upshot, we anchor our causal inquiries within a mult-step framework of data analysis. This involves: \n\n1. clearly defining our causal estimand within a specified *target population,*\n2. clarifying assumptions, & especially identification assumptions, \n3. describing a statistical strategy for extracting this estimand from the data, and then \n4. applying an algorithm that embodies this statistical method.\n\n\n## Methods for Statistical Estimation in Causal Inference: Inverse Probability of Treatment Weights Using Propensity Scores\n\nLast week, we discussed confounding control using regression adjustment. Recall the formula for the average treatment effect (ATE) when conditioning on a set of covariates $L$:\n\n$$\n\\begin{aligned}\n\\text{ATE} = E[Y^{a=1} \\mid L = l] - E[Y^{a=0} \\mid L = l] \\quad \\text{for any value of } l\n\\end{aligned}\n$$\n\n> \"We say that a set $L$ of measured non-descendants of $L$ is a sufficient set for confounding adjustment when conditioning on $L$ blocks all backdoor paths—that is, the treated and the untreated are exchangeable within levels of $L$\" (Hernán & Robins, *Causal Inference*, p. 86).\n\nThis formula calculates the expected outcome difference between treated ($a=1$) and untreated ($a=0$) groups, given a specific value of the covariates $l$.\n\nInverse Probability of Treatment Weighting (IPTW) takes a different approach. We create a pseudo-population where the treatment assignment is independent of the observed covariates by assigning weights to each individual based on their propensity scores.\n\n**We do this by modelling the treatment**\n\nDenote the treatment indicator by $A$, where $A = 1$ if an individual receives treatment and $A = 0$ otherwise. $L$ represents the vector of observed covariates, and $Y^a$ the potential outcomes. The propensity score, $e(L)$, is defined as the probability of receiving the treatment given the observed covariates:\n\n$$\n\\hat{e}(L) = P(A = 1 \\mid L)\n$$\n\nTo obtain IPTW weights, compute the inverse probability of treatment:\n\n$$\nv_i = \\frac{A_i}{\\hat{e}(L_i)} + \\frac{1 - A_i}{1 - \\hat{e}(L_i)}\n$$\n\nWhich simplifies to \n\n$$\nv_i = \n\\begin{cases} \n\\frac{1}{\\hat{e}} & \\text{if } A_i = 1 \\\\\n\\frac{1}{1-\\hat{e}} & \\text{if } A_i = 0 \n\\end{cases}\n$$\n\nwhere $v_i$ is the IPTW weight for individual $i$, $A_i$ is the treatment indicator for individual $i$, and $\\hat{e}(L_i)$ is the estimated propensity score for individual $i$.   \n\nHow might we use these weights to obtain causal effect estimates?\n\n\n\n### Marginal Structural Models (MSMs)\n\nMarginal Structural Models (MSMs) estimate causal effects without requiring an \"outcome model\" that stratifies on covariates. Rather, MSMs employ weights derived from the inverse probability of treatment weighting (IPTW) to create a pseudo-population in which the distribution of covariates is independent of treatment assignment over time.\n\nThe general form of an MSM can be expressed as follows:\n\n$$\nE[Y^a] = \\beta_0 + \\beta_1a\n$$\n\nwhere $E[Y^a]$ is the expected outcome under treatment $a$  and $\\beta_0$ and $\\beta_1$ are parameters estimated by fitting the weighted model. Again, the weights used in the MSM, typically derived from the IPTW (or another treatment model), adjust for the confounding, allowing the model to estimate the unbiased effect of the treatment on the outcome without requiring covariates in the model.\n\nWhere do weights fit in?   Note, we have $E[Y^a]$ in please of $E[Y|A=a]$.  When applying propensity score weights in the linear regression model $E[Y^a] = \\beta_0 + \\beta_1a$, each observation is weighted by $v_i$, such that $v_i(\\beta_0 + \\beta_1a)$. This changes the estimation process to focus on a weighted sum of outcomes, where each individual's contribution is adjusted to reflect their probability of receiving the treatment, given their covariates.\n\n\n## Interpretation of $\\beta_0$ and $\\beta_1$  in a Marginal Structural Model\n\n### Binary Treatment\n\nIn models where the treatment $a$ is binary (e.g., $a = 0$ or $a = 1$), such as in many causal inference studies:\n\n- **$\\beta_0$**: the expected value of the outcome $Y$ when the treatment is not applied ($a = 0$). This is the baseline level of the outcome in the absence of treatment.\n- **$\\beta_1$**: the change in the expected outcome when the treatment status changes from 0 to 1. In logistic regression, $\\beta_1$ represents the log-odds ratio of the outcome for the treatment group relative to the control group. In linear regression, $\\beta_1$ quantifies the difference in the average outcome between the treated and untreated groups.\n\n### Continuous Treatment\n\nWhen the treatment $a$ is continuous, the interpretation of $\\beta_0$ and $\\beta_1$ adjusts slightly:\n\n- **$\\beta_0$**: represents the expected value of the outcome $Y$ when the treatment $a$ is at its reference value (often zero). \n- **$\\beta_1$**: represents the expected change in the outcome for each unit increase in the treatment. In this case, $\\beta_1$ measures the gradient or slope of the relationship between the treatment and the outcome. For every one-unit increase in treatment, the outcome changes by $\\beta_1$ units, assuming all other factors remain constant.\n\n\n<!-- ### Example: Binary treatment, Binary outcome -->\n\n<!-- ### Logistic Regression Model -->\n\n<!-- In the logistic regression (binary outcomes), the Marginal Structural Model (MSM) model is specified as: -->\n<!-- $$ -->\n<!-- \\text{Logit}(E[Y^a]) = \\beta_0 + \\beta_1 a, -->\n<!-- $$ -->\n\n<!-- where $a$ is the treatment indicator (0 for no treatment, 1 for treatment). -->\n\n<!-- ### Calculation for$Y^{a=0}$(No Treatment) -->\n\n<!-- - **Model Simplification**: when$a = 0$(no treatment), the logit model simplifies to: -->\n\n<!--  $$ -->\n<!--   \\text{Logit}(E[Y^{a=0}]) = \\beta_0. -->\n<!--  $$ -->\n\n\n<!-- - **Expected Outcome**: To find$E[Y^{a=0}]$, convert the logit back to probability: -->\n\n<!--  $$ -->\n<!--   E[Y^{a=0}] = \\frac{e^{\\beta_0}}{1 + e^{\\beta_0}} -->\n<!--  $$ -->\n\n<!--   This formula gives the predicted probability of the outcome occurring when there is no treatment. -->\n\n<!-- ### Calculation for$Y^{a=1}$(Treatment Given) -->\n\n<!-- - **Model Specification**: when$a = 1$(treatment given), the logit model is: -->\n\n<!--  $$ -->\n<!--   \\text{Logit}(E[Y^{a=1}]) = \\beta_0 + \\beta_1. -->\n<!--  $$ -->\n\n<!-- - **Expected Outcome**: To find$E[Y^{a=1}]$, similarly convert the logit to probability: -->\n\n<!--  $$ -->\n<!--   E[Y^{a=1}] = \\frac{e^{\\beta_0 + \\beta_1}}{1 + e^{\\beta_0 + \\beta_1}}. -->\n<!--  $$ -->\n\n<!--   This is the predicted probability of the outcome occurring when the treatment is applied. -->\n\n<!-- ### Example of MSM -->\n\n<!-- Suppose$\\beta_0 = -0.5$and$\\beta_1 = 0.8$. Then: -->\n\n<!-- - **No Treatment**:  -->\n\n<!--  $$ -->\n<!--   E[Y^{a=0}] = \\frac{e^{-0.5}}{1 + e^{-0.5}} \\approx \\frac{0.607}{1.607} \\approx 0.378, -->\n<!--  $$ -->\n\n\n<!-- indicating a 37.8% probability of the outcome occurring without treatment. -->\n\n<!-- - **With Treatment**: -->\n<!--  $$ -->\n<!--   E[Y^{a=1}] = \\frac{e^{-0.5 + 0.8}}{1 + e^{-0.5 + 0.8}} = \\frac{e^{0.3}}{1 + e^{0.3}} \\approx \\frac{1.35}{2.35} \\approx 0.574, -->\n<!--  $$ -->\n\n<!-- indicating a 57.4% probability of the outcome occurring with treatment. -->\n\n\n###  How can we apply marginal structural models in subgroups? \n\n\n### Assumptions\n\n- **Model assumptions**: the treatment model is correctly specified.\n- **Causal assumptions**: all confounders are appropriately controlled, positivity and consistency assumptions hold.\n\n\n### Calculating Treatment Weights (Propensity Scores) and Confounding Control in Subgroups\n\nWe may often achieve greater balance when conducting weighted analyses in subgroups by estimating propensity scores *within* these subgroups. The propensity score $ e(L, G) $ is the conditional probability of receiving the exposure $ A = 1 $, given the covariates $ L $ and subgroup indicator $ G $. This is often modelled using logistic regression or other methods that ensure covariate balance\nWe define the estimated propensity score as follows:\n\n$$\n\\hat{e} = P(A = 1 \\mid L, G) = f_A(L, G; \\theta_A)\n$$\n\nHere, $ f_A(L, G; \\theta_A) $ is the statistical model estimating the probability of exposure $A = 1$ given covariates $L$ and subgroup $G$. We then calculate the weights for each individual, denoted $v$, using the estimated propensity score:\n\n\n\nThese weights $v$ depend on $A$ and are calculated as the inverse of the propensity score for exposed individuals and as the inverse of $ 1-\\hat{e} $ for unexposed individuals.\n\nPropensity scores are estimated *separately* within strata of the subgroup to control for potential confounding tailored to each subgroup. These weights $v$ are specific to each individual in subgroup $G$. In the lab, we will clarify how to fit models to estimate contrasts for the causal effects within groups $\\hat{\\delta}_{g}, \\hat{\\delta}_{g'}$, etc., and how to obtain estimates for group-wise differences:\n\n$$\n\\hat{\\gamma} = \\overbrace{\\big( \\hat{E}[Y^a \\mid G=g] - \\hat{E}[Y^{a'} \\mid G=g] \\big)}^{\\hat{\\delta}_g} - \\overbrace{\\big( \\hat{E}[Y^{a'} \\mid G=g'] - \\hat{E}[Y^a \\mid G=g'] \\big)}^{\\hat{\\delta}_{g'}}\n$$\n\n\n- **$\\hat{E}[Y^a \\mid G=g]$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g$.\n- **$\\hat{E}[Y^{a'} \\mid G=g]$**: Estimated expected outcome when a different treatment or control $a'$ is applied to the same subgroup $G=g$.\n- **$\\hat{\\delta}_g$**: Represents the estimated treatment effect within subgroup $G=g$, computed as the difference in expected outcomes between treatment $a$ and $a'$ within this subgroup.\n\n- **$\\hat{E}[Y^{a'} \\mid G=g']$**: Estimated expected outcome when treatment $a'$ is applied to a different subgroup $G=g'$.\n- **$\\hat{E}[Y^a \\mid G=g']$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g'$.\n- **$\\hat{\\delta}_{g'}$**: Represents the estimated treatment effect within subgroup $G=g'$, computed as the difference in expected outcomes between treatment $a'$ and $a$ within this subgroup.\n\n- **$\\hat{\\gamma}$**: The overall measure calculated from your formula represents the difference in treatment effects between two subgroups, $G=g$ and $G=g'$. It quantifies how the effect of switching between treatments $a$ and $a'$ differs across the two subgroups.\n\n\n### Considerations\n\n- **Estimation**: to estimate the expected outcomes $\\hat{E}[Y^a \\mid G]$ and $\\hat{E}[Y^{a'} \\mid G]$, we require statistical models. If we use regression, we include interaction terms between treatment and subgroup indicators to directly estimate subgroup-specific treatment effects. Our use depends on correct model specification.\n- **Confidence intervals**: we may compute confidence intervals for $\\hat{\\gamma}$ using bootstrap, the delta method, or -- in our excercises -- simulation based methods.\n- **Causal assumptions**: again, a causal interpretation of $\\hat{\\gamma}$ relies on satisfying both causal assumptions and modelling assumptions.  Here, we have described estimation using propensity scores.\n\n\n## Doubly Robust Estimation\n\nWe can combine regression-based estimation and doubly robust estimation. I will walk you through the steps in the lab. The TL;DR is this: doubly robust estimation leads to lower reliance on correct model specification. If either the PS model or the regression model is correctly specified, the model will be unbiased -- if the other causal inference assumptions are met.\n\nWe cannot know whether these assumptions are met, we will need to do a sensitivity analysis, the topic of next week.\n\nI'll show you in lab how to employ simulation-based inference methods to compute standard errors and confidence intervals, following the approaches suggested by Greifer (2023)[].\n\n## Readings:\n\nNoah Griefer's Software and Blogs: [https://ngreifer.github.io/blog/subgroup-analysis-psm/](https://ngreifer.github.io/blog/)\n\n\n# Lab\n\n\nToday we estimate causal effects\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# uncomment, update the margot package\n# devtools::install_github(\"go-bayes/margot\")\n\n# load packages\nlibrary(tidyverse)\nlibrary(margot)\nlibrary(skimr)\nlibrary(naniar)\nlibrary(WeightIt)\nlibrary(clarify)\nlibrary(MatchThem)\nlibrary(cobalt)\nlibrary(MatchIt)\nlibrary(kableExtra)\nlibrary(lmtp)\n#library(SuperLearner)\n#library(ranger)\n#library(nnls)\n#library(polspline)\n# create a folder names saved (you should have done this last week).\n# set your path to this folder\n\n# save in cloud if using github\npush_mods <- here::here('/Users/joseph/Library/CloudStorage/Dropbox-v-project/data/saved')\n\n# check it is correct\n# uncomment, check\n#push_mods\n\n# set seed for reproducability\nset.seed(123)\n\n\n# eliminate haven labels\ndf_nz <- as.data.frame(df_nz)\ndf_nz <- haven::zap_formats(df_nz)\ndf_nz <- haven::zap_label(df_nz)\ndf_nz <- haven::zap_widths(df_nz)\n\n# read functions\n# source(\"/Users/joseph/GIT/templates/functions/funs.R\")\n\n# experimental functions (more functions)\n# source(\n#   \"https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R\"\n# )\n# # set exposure name\n\nname_exposure <-  \"perfectionism\"\n\n# check missing values\nskimr::skim(df_nz) |> arrange(n_missing)\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |      |\n|:------------------------|:-----|\n|Name                     |df_nz |\n|Number of rows           |60000 |\n|Number of columns        |130   |\n|_______________________  |      |\n|Column type frequency:   |      |\n|factor                   |6     |\n|numeric                  |124   |\n|________________________ |      |\n|Group variables          |None  |\n\n\n**Variable type: factor**\n\n|skim_variable                 | n_missing| complete_rate|ordered | n_unique|top_counts                                    |\n|:-----------------------------|---------:|-------------:|:-------|--------:|:---------------------------------------------|\n|id                            |         0|          1.00|FALSE   |    20000|1: 3, 2: 3, 3: 3, 4: 3                        |\n|wave                          |         0|          1.00|FALSE   |        3|201: 20000, 201: 20000, 202: 20000            |\n|gen_cohort                    |         0|          1.00|TRUE    |        5|gen: 24828, gen: 19965, gen: 11664, gen: 2280 |\n|eth_cat                       |       786|          0.99|FALSE   |        4|eur: 47556, mao: 6843, asi: 3321, pac: 1494   |\n|religion_bigger_denominations |     12562|          0.79|FALSE   |       11|not: 30926, chr: 5557, cat: 3632, ang: 2274   |\n|alert_level_combined_lead     |     20784|          0.65|FALSE   |        6|no_: 35035, ear: 1618, ale: 1274, ale: 670    |\n\n\n**Variable type: numeric**\n\n|skim_variable                                | n_missing| complete_rate|      mean|       sd|    p0|      p25|      p50|       p75|       p100|hist  |\n|:--------------------------------------------|---------:|-------------:|---------:|--------:|-----:|--------:|--------:|---------:|----------:|:-----|\n|male                                         |         0|          1.00|      0.37|     0.48|  0.00|     0.00|     0.00|      1.00|       1.00|▇▁▁▁▅ |\n|sample_frame                                 |         0|          1.00|      8.26|     2.86|  1.10|     6.90|    10.10|     10.10|      10.90|▁▁▁▂▇ |\n|sample_frame_opt_in                          |         0|          1.00|      0.03|     0.16|  0.00|     0.00|     0.00|      0.00|       1.00|▇▁▁▁▁ |\n|year_measured                                |         0|          1.00|      0.79|     0.42| -1.00|     1.00|     1.00|      1.00|       1.00|▁▁▂▁▇ |\n|rural_gch_2018_l                             |       578|          0.99|      1.66|     0.98|  1.00|     1.00|     1.00|      2.00|       5.00|▇▂▂▁▁ |\n|regc_2022_l                                  |       593|          0.99|      7.16|     5.07|  1.00|     2.00|     7.00|     13.00|      99.00|▇▁▁▁▁ |\n|nz_dep2018                                   |       596|          0.99|      4.79|     2.74|  1.00|     2.04|     4.95|      7.00|      10.00|▇▇▆▅▃ |\n|born_nz                                      |       702|          0.99|      0.78|     0.41|  0.00|     1.00|     1.00|      1.00|       1.00|▂▁▁▁▇ |\n|edu                                          |      1523|          0.97|      5.42|     2.69|  0.00|     3.00|     7.00|      7.00|      10.00|▃▃▃▇▂ |\n|nzsei_13_l                                   |      4500|          0.92|     54.57|    16.64| 10.00|    42.00|    56.00|     69.00|      90.00|▁▃▅▇▁ |\n|age                                          |     12229|          0.80|     50.96|    13.76| 18.12|    41.19|    53.35|     61.56|      97.90|▂▅▇▂▁ |\n|sample_weights                               |     12229|          0.80|      1.00|     1.27|  0.30|     0.48|     0.65|      0.93|      19.96|▇▁▁▁▁ |\n|sfhealth                                     |     12242|          0.80|      5.04|     1.17|  1.00|     4.34|     5.04|      5.96|       7.00|▁▂▃▇▅ |\n|perfectionism                                |     12247|          0.80|      3.12|     1.37|  1.00|     2.01|     3.00|      4.03|       7.00|▇▇▅▃▁ |\n|gratitude                                    |     12248|          0.80|      5.90|     0.88|  1.00|     5.34|     6.01|      6.65|       7.00|▁▁▁▅▇ |\n|forgiveness                                  |     12255|          0.80|      5.08|     1.27|  1.00|     4.31|     5.32|      6.02|       7.00|▁▂▃▇▇ |\n|vengeful_rumin                               |     12255|          0.80|      2.92|     1.27|  1.00|     1.98|     2.68|      3.68|       7.00|▇▇▃▂▁ |\n|lifemeaning                                  |     12261|          0.80|      5.45|     1.18|  1.00|     4.96|     5.53|      6.46|       7.00|▁▁▃▅▇ |\n|support                                      |     12268|          0.80|      5.94|     1.12|  1.00|     5.35|     6.29|      6.96|       7.00|▁▁▁▃▇ |\n|nwi                                          |     12306|          0.79|      5.30|     1.67|  0.00|     4.30|     5.33|      6.38|      10.00|▁▃▇▆▁ |\n|sfhealth_get_sick_easier_reversed            |     12344|          0.79|      5.67|     1.62|  1.00|     4.99|     6.02|      6.99|       7.00|▁▁▁▁▇ |\n|meaning_sense                                |     12380|          0.79|      5.72|     1.20|  1.00|     5.01|     5.99|      6.96|       7.00|▁▁▁▂▇ |\n|parent                                       |     12398|          0.79|      0.73|     0.45|  0.00|     0.00|     1.00|      1.00|       1.00|▃▁▁▁▇ |\n|self_control_wish_more_reversed              |     12398|          0.79|      3.73|     1.82|  1.00|     2.03|     3.04|      5.03|       7.00|▇▆▅▃▆ |\n|pwb_your_future_security                     |     12403|          0.79|      6.32|     2.35|  0.00|     4.98|     6.98|      8.01|      10.00|▂▃▆▇▆ |\n|emotion_regulation_hide_neg_emotions         |     12408|          0.79|      4.19|     1.66|  1.00|     2.99|     4.04|      5.05|       7.00|▆▅▆▇▇ |\n|pwb_your_health                              |     12442|          0.79|      6.68|     2.33|  0.00|     5.02|     7.02|      8.04|      10.00|▁▂▅▇▇ |\n|pwb_standard_living                          |     12457|          0.79|      7.68|     2.00|  0.00|     6.97|     8.00|      9.02|      10.00|▁▁▂▅▇ |\n|pwb_your_relationships                       |     12460|          0.79|      7.71|     2.26|  0.00|     6.97|     8.03|      9.03|      10.00|▁▁▂▃▇ |\n|neighbourhood_community                      |     12461|          0.79|      4.27|     1.63|  1.00|     3.00|     4.04|      5.95|       7.00|▆▅▆▇▇ |\n|power_no_control_composite                   |     12469|          0.79|      2.92|     1.41|  1.00|     1.96|     2.55|      3.99|       7.00|▇▅▆▂▁ |\n|power_no_control_composite_reversed          |     12469|          0.79|      5.08|     1.41|  1.00|     4.01|     5.45|      6.04|       7.00|▁▂▆▅▇ |\n|sfhealth_expect_worse_health_reversed        |     12478|          0.79|      4.12|     1.73|  1.00|     2.98|     4.00|      5.96|       7.00|▆▆▆▃▇ |\n|employed                                     |     12558|          0.79|      0.79|     0.41|  0.00|     1.00|     1.00|      1.00|       1.00|▂▁▁▁▇ |\n|religion_religious                           |     12561|          0.79|      0.35|     0.48|  0.00|     0.00|     0.00|      1.00|       1.00|▇▁▁▁▅ |\n|conscientiousness                            |     12616|          0.79|      5.12|     1.05|  1.00|     4.47|     5.24|      5.96|       7.00|▁▁▅▇▅ |\n|extraversion                                 |     12618|          0.79|      3.86|     1.19|  1.00|     3.01|     3.80|      4.72|       7.00|▂▆▇▅▁ |\n|openness                                     |     12622|          0.79|      4.96|     1.11|  1.00|     4.22|     5.00|      5.77|       7.00|▁▂▆▇▅ |\n|agreeableness                                |     12626|          0.79|      5.36|     0.99|  1.00|     4.74|     5.48|      6.03|       7.00|▁▁▃▇▆ |\n|belong                                       |     12626|          0.79|      5.11|     1.08|  1.00|     4.36|     5.30|      5.98|       7.00|▁▁▃▇▅ |\n|honesty_humility                             |     12627|          0.79|      5.50|     1.16|  1.00|     4.75|     5.72|      6.47|       7.00|▁▁▃▆▇ |\n|neuroticism                                  |     12628|          0.79|      3.48|     1.15|  1.00|     2.71|     3.47|      4.25|       7.00|▃▇▇▃▁ |\n|self_esteem                                  |     12633|          0.79|      5.14|     1.29|  1.00|     4.32|     5.34|      6.04|       7.00|▁▂▃▇▇ |\n|power_self_nocontrol                         |     12642|          0.79|      2.96|     1.64|  1.00|     1.96|     2.95|      4.02|       7.00|▇▂▂▂▂ |\n|kessler6_sum                                 |     12650|          0.79|      5.31|     4.11|  0.00|     2.03|     4.04|      7.04|      24.00|▇▆▂▁▁ |\n|kessler_latent_depression                    |     12654|          0.79|      0.58|     0.74|  0.00|     0.01|     0.32|      0.98|       4.00|▇▂▁▁▁ |\n|kessler_latent_anxiety                       |     12656|          0.79|      1.20|     0.77|  0.00|     0.66|     1.04|      1.68|       4.00|▇▇▆▁▁ |\n|lifesat                                      |     12666|          0.79|      5.29|     1.21|  1.00|     4.53|     5.50|      6.03|       7.00|▁▁▃▆▇ |\n|support_turnto                               |     12688|          0.79|      5.88|     1.28|  1.00|     5.03|     6.02|      6.99|       7.00|▁▁▁▂▇ |\n|emotion_regulation_out_control               |     12701|          0.79|      2.81|     1.66|  1.00|     1.04|     2.03|      4.01|       7.00|▇▂▂▂▁ |\n|modesty                                      |     12709|          0.79|      6.04|     0.92|  1.00|     5.50|     6.24|      6.79|       7.00|▁▁▁▃▇ |\n|pers_honestyhumility_seen_expensivecar       |     12737|          0.79|      5.66|     1.56|  1.00|     4.97|     6.02|      6.99|       7.00|▁▁▁▂▇ |\n|belong_beliefs                               |     12741|          0.79|      4.77|     1.28|  1.00|     3.99|     4.99|      5.98|       7.00|▂▂▆▇▇ |\n|hlth_weight                                  |     12742|          0.79|     79.29|    18.55| 35.03|    65.04|    77.00|     89.99|     209.99|▅▇▁▁▁ |\n|pers_honestyhumility_deserve_more            |     12743|          0.79|      5.30|     1.53|  1.00|     4.02|     5.97|      6.96|       7.00|▁▁▂▂▇ |\n|hlth_fatigue                                 |     12756|          0.79|      1.64|     1.07|  0.00|     0.98|     1.96|      2.04|       4.00|▃▇▇▃▁ |\n|kessler_depressed                            |     12765|          0.79|      0.47|     0.78|  0.00|     0.00|     0.02|      0.98|       4.00|▇▂▁▁▁ |\n|belong_routside_reversed                     |     12767|          0.79|      5.04|     1.74|  1.00|     3.97|     5.95|      6.96|       7.00|▂▂▂▂▇ |\n|pers_agreeable_sympathise_others             |     12767|          0.79|      5.64|     1.16|  1.00|     5.00|     5.98|      6.05|       7.00|▁▁▁▃▇ |\n|pers_honestyhumility_pleasure_expensivegoods |     12767|          0.79|      5.32|     1.66|  1.00|     4.01|     5.98|      6.97|       7.00|▁▂▂▂▇ |\n|bodysat                                      |     12768|          0.79|      4.23|     1.70|  1.00|     2.99|     4.04|      5.97|       7.00|▅▅▅▆▇ |\n|rumination                                   |     12768|          0.79|      0.83|     0.99|  0.00|     0.00|     0.95|      1.04|       4.00|▇▅▂▁▁ |\n|kessler_restless                             |     12779|          0.79|      1.22|     0.94|  0.00|     0.95|     1.02|      1.99|       4.00|▅▇▆▂▁ |\n|kessler_nervous                              |     12785|          0.79|      1.16|     0.94|  0.00|     0.04|     1.01|      1.98|       4.00|▆▇▅▂▁ |\n|kessler_worthless                            |     12788|          0.79|      0.50|     0.84|  0.00|     0.00|     0.02|      0.99|       4.00|▇▂▁▁▁ |\n|selfesteem_failure_reversed                  |     12791|          0.79|      5.23|     1.63|  1.00|     4.01|     5.97|      6.96|       7.00|▁▂▂▂▇ |\n|kessler_effort                               |     12794|          0.79|      1.23|     0.98|  0.00|     0.05|     1.01|      1.99|       4.00|▅▇▅▂▁ |\n|hlth_height                                  |     12795|          0.79|      1.70|     0.10|  1.26|     1.63|     1.69|      1.77|       2.10|▁▂▇▃▁ |\n|kessler_hopeless                             |     12797|          0.79|      0.78|     0.88|  0.00|     0.00|     0.96|      1.04|       4.00|▇▅▃▁▁ |\n|selfesteem_satself                           |     12797|          0.79|      5.13|     1.45|  1.00|     4.03|     5.95|      6.02|       7.00|▁▁▂▃▇ |\n|pers_conscientious_chores_done               |     12808|          0.79|      4.67|     1.50|  1.00|     3.96|     4.98|      5.99|       7.00|▂▃▅▆▇ |\n|pers_conscientious_forget_putback            |     12812|          0.79|      5.15|     1.65|  1.00|     4.00|     5.96|      6.04|       7.00|▂▂▂▂▇ |\n|belong_accept                                |     12814|          0.79|      5.52|     1.27|  1.00|     4.98|     5.98|      6.04|       7.00|▁▁▁▃▇ |\n|pers_agreeable_no_interest_others            |     12819|          0.79|      5.39|     1.36|  1.00|     4.96|     5.97|      6.04|       7.00|▁▁▂▃▇ |\n|pers_extraversion_talk_peopleparties         |     12820|          0.79|      3.81|     1.72|  1.00|     2.04|     3.98|      5.02|       7.00|▇▅▆▅▆ |\n|pers_extraversion_life_party                 |     12828|          0.79|      3.42|     1.44|  1.00|     2.03|     3.05|      4.04|       7.00|▇▆▇▅▂ |\n|selfesteem_postiveself                       |     12830|          0.79|      5.06|     1.41|  1.00|     4.02|     5.03|      6.01|       7.00|▁▂▃▅▇ |\n|pers_neuroticism_upset_easily                |     12843|          0.79|      3.47|     1.52|  1.00|     2.02|     3.03|      4.96|       7.00|▇▅▅▃▂ |\n|pers_neuroticism_mostly_relaxed              |     12844|          0.79|      3.43|     1.42|  1.00|     2.03|     3.03|      4.04|       7.00|▇▇▆▃▂ |\n|pers_neuroticism_mood_swings                 |     12847|          0.79|      3.15|     1.59|  1.00|     1.98|     2.99|      4.03|       7.00|▇▃▃▂▂ |\n|pers_neuroticism_seldom_blue                 |     12851|          0.79|      3.86|     1.66|  1.00|     2.04|     3.99|      5.02|       7.00|▇▅▆▆▆ |\n|pers_conscientious_like_order                |     12853|          0.79|      5.41|     1.29|  1.00|     4.96|     5.96|      6.04|       7.00|▁▁▂▃▇ |\n|pers_extraversion_keepbackground             |     12854|          0.79|      3.92|     1.49|  1.00|     2.98|     3.99|      5.00|       7.00|▆▆▇▆▅ |\n|pers_agreeable_feel_others_emotions          |     12859|          0.79|      5.32|     1.31|  1.00|     4.96|     5.96|      6.03|       7.00|▁▁▂▃▇ |\n|pers_agreeable_no_interest_others_probs      |     12870|          0.79|      5.07|     1.48|  1.00|     4.01|     5.04|      6.02|       7.00|▁▂▂▃▇ |\n|pers_honestyhumility_feel_entitled           |     12873|          0.79|      5.69|     1.32|  1.00|     4.99|     6.00|      6.97|       7.00|▁▁▁▂▇ |\n|pers_openness_vivid_imagination              |     12882|          0.79|      4.67|     1.52|  1.00|     3.96|     4.98|      5.99|       7.00|▂▃▅▆▇ |\n|pers_extraversion_dont_talkalot              |     12894|          0.79|      4.31|     1.59|  1.00|     3.01|     4.03|      5.96|       7.00|▅▅▇▆▇ |\n|pers_conscientious_make_mess                 |     12897|          0.79|      5.26|     1.37|  1.00|     4.03|     5.96|      6.03|       7.00|▁▁▂▃▇ |\n|pers_openness_good_imagination               |     12904|          0.78|      5.22|     1.55|  1.00|     4.02|     5.96|      6.04|       7.00|▁▂▂▃▇ |\n|lifesat_satlife                              |     12917|          0.78|      5.67|     1.23|  1.00|     5.00|     5.99|      6.95|       7.00|▁▁▁▂▇ |\n|pers_openness_difficult_abstraction          |     12918|          0.78|      4.95|     1.54|  1.00|     3.98|     5.02|      6.02|       7.00|▂▂▃▃▇ |\n|pers_openness_interested_abstraction         |     13013|          0.78|      5.00|     1.50|  1.00|     3.99|     5.02|      6.02|       7.00|▁▂▃▃▇ |\n|hlth_bmi                                     |     13016|          0.78|     27.41|     5.93| 12.35|    23.39|    26.26|     30.18|      75.56|▆▇▁▁▁ |\n|smoker                                       |     13077|          0.78|      0.06|     0.24|  0.00|     0.00|     0.00|      0.00|       1.00|▇▁▁▁▁ |\n|self_control_have_lots                       |     13107|          0.78|      5.04|     1.43|  1.00|     4.02|     5.03|      6.01|       7.00|▁▂▂▅▇ |\n|religion_identification_level                |     13120|          0.78|      2.33|     2.17|  1.00|     1.00|     1.00|      4.00|       7.00|▇▁▁▁▂ |\n|meaning_purpose                              |     13302|          0.78|      5.18|     1.43|  1.00|     4.04|     5.04|      6.03|       7.00|▁▁▂▅▇ |\n|support_help                                 |     13303|          0.78|      6.07|     1.16|  1.00|     5.96|     6.04|      7.00|       7.00|▁▁▁▁▇ |\n|partner                                      |     13333|          0.78|      0.76|     0.43|  0.00|     1.00|     1.00|      1.00|       1.00|▂▁▁▁▇ |\n|permeability_individual                      |     13371|          0.78|      5.20|     1.24|  1.00|     4.05|     5.03|      6.01|       7.00|▁▁▃▆▇ |\n|support_noguidance_reversed                  |     13373|          0.78|      5.88|     1.47|  1.00|     5.04|     6.04|      7.00|       7.00|▁▁▁▁▇ |\n|impermeability_group                         |     13408|          0.78|      3.67|     1.58|  1.00|     2.04|     3.97|      4.99|       7.00|▇▆▇▆▃ |\n|alcohol_frequency                            |     13462|          0.78|      2.17|     1.35|  0.00|     1.00|     2.02|      3.03|       5.00|▇▇▇▇▃ |\n|hours_charity                                |     13563|          0.77|      1.42|     4.18|  0.00|     0.00|     0.02|      0.99|     168.00|▇▁▁▁▁ |\n|hours_exercise                               |     13565|          0.77|      6.02|     7.80|  0.00|     2.00|     4.03|      7.02|     168.00|▇▁▁▁▁ |\n|religion_believe_god                         |     13809|          0.77|      0.44|     0.50|  0.00|     0.00|     0.00|      1.00|       1.00|▇▁▁▁▆ |\n|religion_believe_spirit                      |     13809|          0.77|      0.67|     0.47|  0.00|     0.00|     1.00|      1.00|       1.00|▃▁▁▁▇ |\n|sfhealth_your_health                         |     13942|          0.77|      5.33|     1.26|  1.00|     4.96|     5.96|      6.02|       7.00|▁▁▂▃▇ |\n|power_others_control                         |     14051|          0.77|      2.87|     1.61|  1.00|     1.95|     2.05|      4.01|       7.00|▇▂▂▂▁ |\n|emotion_regulation_change_thinking_to_calm   |     14177|          0.76|      4.81|     1.45|  1.00|     3.99|     5.00|      5.99|       7.00|▂▂▅▇▇ |\n|lifesat_ideal                                |     14186|          0.76|      4.89|     1.43|  1.00|     4.00|     5.01|      6.00|       7.00|▂▂▃▆▇ |\n|religion_perceive_religious_discrim          |     14198|          0.76|      1.96|     1.40|  1.00|     1.00|     1.04|      2.04|       7.00|▇▁▁▁▁ |\n|hlth_sleep_hours                             |     14277|          0.76|      6.94|     1.12|  2.00|     6.02|     7.00|      7.97|      20.00|▁▇▁▁▁ |\n|charity_donate                               |     14501|          0.76|   1013.80|  6682.04|  0.00|    20.03|   149.97|    500.02|  650000.00|▇▁▁▁▁ |\n|alcohol_intensity                            |     14605|          0.76|      2.08|     2.08|  0.00|     0.98|     1.97|      2.96|      36.00|▇▁▁▁▁ |\n|political_conservative                       |     14644|          0.76|      3.57|     1.37|  1.00|     2.05|     3.96|      4.04|       7.00|▆▅▇▃▂ |\n|household_inc                                |     14744|          0.75| 117927.50| 97598.66|  1.00| 59999.96| 99999.98| 150000.02| 3000000.00|▇▁▁▁▁ |\n|pol_wing                                     |     15139|          0.75|      3.71|     1.30|  1.00|     2.97|     3.98|      4.05|       7.00|▅▅▇▃▂ |\n|sexual_satisfaction                          |     15680|          0.74|      4.51|     1.77|  1.00|     3.04|     4.97|      6.00|       7.00|▃▂▅▅▇ |\n|emp_job_sat                                  |     23630|          0.61|      5.31|     1.45|  1.00|     4.96|     5.96|      6.04|       7.00|▁▁▂▃▇ |\n|emp_job_secure                               |     23677|          0.61|      5.49|     1.55|  1.00|     4.97|     5.99|      6.97|       7.00|▁▁▁▂▇ |\n|emp_job_valued                               |     23912|          0.60|      5.18|     1.65|  1.00|     4.02|     5.96|      6.05|       7.00|▂▁▂▃▇ |\n|home_owner                                   |     27754|          0.54|      0.76|     0.43|  0.00|     1.00|     1.00|      1.00|       1.00|▂▁▁▁▇ |\n\n\n:::\n\n```{.r .cell-code}\n# obtain ids for individuals who participated in 2018 and have no missing baseline exposure\nids_2018 <- df_nz |>\n  dplyr::filter(year_measured == 1, wave == 2018) |>\n  dplyr::filter(!is.na(!!sym(name_exposure))) |> # criteria, no missing\n  dplyr::filter(!is.na(eth_cat)) |> # criteria, no missing\n  pull(id)\n\n\n# obtain ids for individuals who participated in 2019\nids_2019 <- df_nz |>\n  dplyr::filter(year_measured == 1, wave == 2019) |>\n  dplyr::filter(!is.na(!!sym(name_exposure))) |> # criteria, no missing\n  pull(id)\n\n# intersect IDs from 2018 and 2019 to ensure participation in both years\nids_2018_2019 <- intersect(ids_2018, ids_2019)\n\n# data wrangling\ndat_long <- df_nz |>\n  dplyr::filter(id %in% ids_2018_2019 &\n                  wave %in% c(2018, 2019, 2020)) |>\n  arrange(id, wave) |>\n  select(\n    \"id\",\n    \"wave\",\n    \"year_measured\",\n    \"age\",\n    \"male\",\n    \"born_nz\",\n    \"eth_cat\",\n    #factor(EthCat, labels = c(\"Euro\", \"Maori\", \"Pacific\", \"Asian\")),\n    \"employed\",\n    # are you currently employed? (this includes self-employment or casual work)\n    \"edu\",\n    # \"gen_cohort\",\n    \"household_inc\",\n    \"partner\",\n    # 0 = no, 1 = yes\n    \"parent\",\n    \"alert_level_combined_lead\", # see bibliography\n    # 0 = no, 1 = yes\n    \"political_conservative\", # see nzavs sheet\n    \"hours_exercise\", # see nzavs sheet\n    \"agreeableness\", \n    # Mini-IPIP6 Agreeableness (also modelled as empathy facet)\n    # Sympathize with others' feelings.\n    # Am not interested in other people's problems.\n    # Feel others' emotions.\n    # Am not really interested in others.\n    \"conscientiousness\",\n    # see mini ipip6\n    # Get chores done right away.\n    # Like order.\n    # Make a mess of things.\n    # Often forget to put things back in their proper place.\n    \"extraversion\",\n    # Mini-IPIP6 Extraversion\n    # Am the life of the party.\n    # Don't talk a lot.\n    # Keep in the background.\n    # Talk to a lot of different people at parties.\n    \"honesty_humility\",\n    # see mini ipip6\n    # Would like to be seen driving around in a very expensive car.\n    # Would get a lot of pleasure from owning expensive luxury goods.\n    # Feel entitled to more of everything.\n    # Deserve more things in life.\n    \"openness\",\n    # see mini ipip6\n    # Have a vivid imagination.\n    # Have difficulty understanding abstract ideas.\n    # Do not have a good imagination.\n    # Am not interested in abstract ideas.\n    \"neuroticism\",\n    # see mini ipip6\n    # Have frequent mood swings.\n    # Am relaxed most of the time.\n    # Get upset easily.\n    # Seldom feel blue.\n    \"modesty\",\n    # # see mini ipip6\n    # # I want people to know that I am an important person of high status,\n    # # I am an ordinary person who is no better than others.\n    # # I wouldn’t want people to treat me as though I were superior to them.\n    # # I think that I am entitled to more respect than the average person is\n    #\"w_gend_age_ethnic\",\n    \"neighbourhood_community\",\n    # #I feel a sense of community with others in my local neighbourhood.\n    \"belong\", # see nzavs sheet\n    \"rural_gch_2018_l\",# see nzavs sheet\n    \"support\",\n    # \"support_help\",\n    # # 'There are people I can depend on to help me if I really need it.\n    # \"support_turnto\",\n    # # There is no one I can turn to for guidance in times of stress.\n    # \"support_rnoguidance\",\n    #There is no one I can turn to for guidance in times of stress.\n    \"perfectionism\",\n    \"religion_religious\",\n    \"kessler_latent_depression\",\n    \"kessler_latent_anxiety\"\n  ) |>\n  mutate(\n    #initialize 'censored'\n    censored = ifelse(lead(year_measured) == 1, 1, 0),\n    \n    # modify 'censored' based on the condition; no need to check for NA here as 'censored' is already defined in the previous step\n    censored =  ifelse(is.na(censored) &\n                         year_measured == 1, 1, censored),\n    # create urban binary variable\n    \n    urban = ifelse(rural_gch_2018_l == 1, 1, 0)\n    \n  ) |>\n  select(-c(year_measured, rural_gch_2018_l) )|>\n  dplyr::mutate(\n    # rescale these variables, to get all variables on a similar scale\n    # otherwise your models can blow up, or become uninterpretable. \n    household_inc_log = log(household_inc + 1),\n    hours_exercise_log = log(hours_exercise + 1)  ) |>\n  dplyr::select(\n    -c(\n      household_inc,\n      hours_exercise)\n  ) |>\n  droplevels() |>\n  # dplyr::rename(sample_weights = w_gend_age_ethnic,\n  #               sample_origin =  sample_origin_names_combined) |>\n  arrange(id, wave) |>\n  mutate(\n    urban = as.numeric(as.character(urban)),\n    #   parent = as.numeric(as.character(parent)),\n    partner = as.numeric(as.character(partner)),\n    born_nz = as.numeric(as.character(born_nz)),\n    censored = as.numeric(as.character(censored)),\n    employed = as.numeric(as.character(employed))\n  ) |>\n  droplevels() |>\n  arrange(id, wave) |>\n  data.frame()\n\n\n# inspect data\nglimpse(dat_long)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 42,990\nColumns: 30\n$ id                        <fct> 1, 1, 1, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6,…\n$ wave                      <fct> 2018, 2019, 2020, 2018, 2019, 2020, 2018, 20…\n$ age                       <dbl> 40.31341, 41.33449, 42.24450, 47.14449, 47.9…\n$ male                      <dbl> 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ born_nz                   <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ eth_cat                   <fct> euro, euro, euro, maori, maori, maori, euro,…\n$ employed                  <dbl> 1, 1, 1, 0, 1, NA, 0, 0, 0, 1, 1, 0, 0, 1, 1…\n$ edu                       <dbl> 8, 8, 8, 3, 3, 3, 6, 6, 6, 6, 6, 6, 7, 7, 7,…\n$ partner                   <dbl> 1, 1, 1, 1, 1, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1…\n$ parent                    <dbl> 1, 1, 1, 1, 1, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1…\n$ alert_level_combined_lead <fct> no_alert, no_alert, no_alert, early_covid, N…\n$ political_conservative    <dbl> 1.000000, 1.022343, 1.042282, 3.021098, 3.02…\n$ agreeableness             <dbl> 6.235760, 6.216993, 6.539885, 4.997000, 4.54…\n$ conscientiousness         <dbl> 5.781907, 6.004211, 4.719577, 5.281236, 4.73…\n$ extraversion              <dbl> 4.740896, 4.737648, 4.724690, 2.752063, 3.23…\n$ honesty_humility          <dbl> 5.954770, 3.970874, 4.988354, 2.249136, 2.75…\n$ openness                  <dbl> 6.502722, 6.469405, 6.237941, 7.000000, 6.52…\n$ neuroticism               <dbl> 2.543777, 3.049655, 2.960180, 2.455489, 2.24…\n$ modesty                   <dbl> 6.786189, 6.002267, 5.702049, 5.239746, 4.74…\n$ neighbourhood_community   <dbl> 6.951882, 6.005449, 5.986452, 4.994146, 3.97…\n$ belong                    <dbl> 4.958810, 6.039168, 5.382137, 6.332741, 5.68…\n$ support                   <dbl> 7.000000, 6.959343, 6.967418, 6.983696, 7.00…\n$ perfectionism             <dbl> 4.303349, 3.670650, 3.337095, 2.660515, 3.33…\n$ religion_religious        <int> 0, 0, 0, 0, 0, NA, 1, 1, 1, 0, 0, 0, 0, 0, 0…\n$ kessler_latent_depression <dbl> 0.037011885, 0.000000000, 0.006337577, 0.000…\n$ kessler_latent_anxiety    <dbl> 0.96853714, 0.98302076, 1.71493734, 1.029461…\n$ censored                  <dbl> 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ urban                     <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ household_inc_log         <dbl> 12.206078, 12.206078, 11.849405, 11.532738, …\n$ hours_exercise_log        <dbl> 0.41844130, 0.01955105, 0.00000000, 3.219609…\n```\n\n\n:::\n\n```{.r .cell-code}\n# more thorough view\n#skimr::skim(dat_long)\n```\n:::\n\n\n\n\nNext let's insure that we obtain 50/50 representation of gender within our estimation.  \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# balance on gender weights\n# calculate gender weights assuming male is coded as 1 and female as 0\nprop_male_population <-\n  0.5  # target proportion of males in the population\nprop_female_population <-\n  0.5  # target proportion of females in the population\n\nprop_male_sample <- mean(dat_long$male)\nprop_female_sample <- 1 - prop_male_sample\n\ngender_weight_male <- prop_male_population / prop_male_sample\ngender_weight_female <- prop_female_population / prop_female_sample\n\ndat_long$sample_weights <-\n  ifelse(dat_long$male == 1, gender_weight_male, gender_weight_female)\n\n# we will upweight males and down weight non-males to obtain a balance of gender in the *target* population\ntable(dat_long$sample_weights)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n0.783745351126667  1.38107170393216 \n            27426             15564 \n```\n\n\n:::\n:::\n\n\nNext let's get our data into shape.  Today we're going to consider a 'treatment' of perfectionism in which we shift people by different quantiles of perfectionism: \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_long <-\n  create_ordered_variable(dat_long, \"perfectionism\", n_divisions = 4) #\n\n# view scale\n# uncommend to see break points\n# print(quantile(dat_long$perfectionism, probs = seq(0, 1, 1/4), na.rm = TRUE))\n\n# n by groups\ntable(dat_long$perfectionism_4tile)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\ntile_1 tile_2 tile_3 tile_4 \n 10049  10049  10048  10049 \n```\n\n\n:::\n\n```{.r .cell-code}\n# obtain labels if useful later\nlabels <- levels(dat_long$perfectionism_4tile)\n```\n:::\n\n\n\n\n\n\n### Consider where the quantiles break\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndt_19 <- dat_long |> filter(wave == 2019)\n\nmargot::coloured_histogram_quantiles(col_name = \"perfectionism\",\n                                     n_quantiles = 4,\n                                     binwidth = .25,\n                                     dt_19)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/unnamed-chunk-5-1.png){width=1152}\n:::\n:::\n\n\n\n\n### Consider mean\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndt_19 <- dat_long |> filter(wave == 2019)\n\nmargot::coloured_histogram_sd(col_name = \"perfectionism\", binwidth = .25, dt_19)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/unnamed-chunk-6-1.png){width=1152}\n:::\n:::\n\n\n\n\n\n### Set variables\n\nNext lets set our baseline variables\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbaseline_vars = c(\"age\", \"male\", \"edu\", \"eth_cat\", \"partner\", \"employed\", \"born_nz\", \"neighbourhood_community\", \"household_inc_log\", \"parent\", \"religion_religious\", \"urban\", \"employed\", \"alert_level_combined_lead\", \"sample_weights\")\n\n# treatment\nexposure_vars = c(\"perfectionism_4tile\") \n\n# outcome, can be many\noutcome_vars = c(\"kessler_latent_anxiety\", \"kessler_latent_depression\")\n```\n:::\n\n\n\n\n\n\n### Muliply impute missing values\n\n\nIn our first analysis we will not merely impute baseline values. Rather we will impute baseline and outcome values within quantiles of the exposure.  Consider, why should we impute within the treatments to be compared?  What are the lingering dangers of this approach? \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# make long data wide\nprep_dat_wide <- margot_wide(dat_long, \n                             baseline_vars = baseline_vars, \n                             exposure_var = exposure_vars,\n                             outcome_vars = outcome_vars)\n\n\n# filter data, so that we impute within quartiles\nlist_filtered_df <-\n  margot::margot_filter(prep_dat_wide, exposure_vars = \"t1_perfectionism_4tile\", sort_var = \"id\")\n\n# check that these add up to the total data set\na <- nrow( list_filtered_df$tile_1)\nb <- nrow( list_filtered_df$tile_2)\nc <- nrow( list_filtered_df$tile_3)\nd <-nrow( list_filtered_df$tile_4)\n\n# must sum to equal\na + b + c + d == nrow(prep_dat_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n:::\n\n\n\n\n#### Visualise missing values\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# visually inspect missingness\nnaniar::vis_miss(prep_dat_wide, warn_large_data = FALSE)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# check for collinear vars\nmice:::find.collinear(prep_dat_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"t0_sample_weights\"\n```\n\n\n:::\n:::\n\n\n\n\n#### Imputations\nNext we impute by quartile.  Save this output in your folder. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# impute by quartile\nmice_health <- margot::impute_and_combine(list_filtered_df,  m = 5 )\n\nmargot::here_save(mice_health, \"mice_health\")\n```\n:::\n\n\n\n\n### Wrangling\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read data if you are not running the imputation again\nmice_health <- here_read(\"mice_health\")\n\n# post-imputation arrange\nmice_health_mids <- mice_health |>\n  arrange(.imp, id) |>\n  rename(sample_weights = t0_sample_weights) |>\ndplyr::mutate(\n  across(\n    where(is.numeric) & !t0_alert_level_combined_lead &\n      !sample_weights,\n    ~ scale(.x),\n    .names = \"{col}_z\"\n  )\n) |>\n  select(-.imp_z, -.id_z) |>\n  select(where(is.factor),\n         sample_weights,\n         ends_with(\"_z\"),\n         .imp,\n         .id) |>\n  relocate(sample_weights, .before = starts_with(\"t1_\"))  |>\n  relocate(id, .before = sample_weights)  |>\n  relocate(starts_with(\"t0_\"), .before = starts_with(\"t1_\"))  |>\n  relocate(starts_with(\"t2_\"), .after = starts_with(\"t1_\"))  |>\n  arrange(.imp, id) |>\n  droplevels() |>\n  mutate_if(is.matrix, as.vector) |>\n  as.mids()\n\n# this is how you save without the margot package\nsaveRDS(mice_health_mids, here::here(\"saved\", \"mice_health_mids\"))\nsaveRDS(mice_health_long, here::here(\"saved\", \"mice_health_long\"))\n```\n:::\n\n\n\n### Compute propensity scores for IPTW\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# this is how you read saved files without the margot package\nmice_health_mids <- readRDS(here::here(\"saved\", \"mice_health_mids\"))\nmice_health_long <- readRDS(here::here(\"saved\", \"mice_health_long\"))\n# propensity scors --------------------------------------------------------\n\n\n# set exposure\nX = \"t1_perfectionism_4tile\"\n\n# set estimand\nestimand = \"ATE\"\n\n# set baseline varaibles\nbaseline_vars_models = mice_health_long |>\n  dplyr::select(starts_with(\"t0\"))|> colnames() # note, we earlier change name of `t0_sample_weights` to `sample weights`\n\n# obtain propensity scores\nmatch_ebal_ate <- margot::match_mi_general(data = mice_health_mids, \n                                      X = X, \n                                      baseline_vars = baseline_vars_models, \n                                      estimand = estimand,  \n                                   #   focal = \"tile_3\", #for ATT\n                                      method = \"ebal\", \n                                      sample_weights = \"sample_weights\")\n\n# save output\nmargot::here_save(match_ebal_ate, \"match_ebal_ate\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# read output\nmatch_ebal_ate <- margot::here_read(\"match_ebal_ate\")\n\n\n# check balance\n# bal.tab(match_ebal_ate)\n\n# visualise imbalance\nlove.plot(match_ebal_ate, binary = \"std\", thresholds = c(m = .1),\n          wrap = 50, position = \"bottom\", size =3)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/vis_matching_ate-1.png){width=1152}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# consider results \nsum_ebal_match_ebal_ate <- summary(match_ebal_ate)\n\n# summarise\nsum_ebal_match_ebal_ate\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                 Summary of weights\n\n- Weight ranges:\n\n          Min                                   Max\ntile_1 0.1578 |---------------------------| 45.8745\ntile_2 0.4208 |---|                          8.1283\ntile_3 0.4646 ||                             3.1414\ntile_4 0.0569 |-------|                     14.2479\n\n- Units with the 5 most extreme weights by group:\n                                               \n           8458    4008    5348    8550   11148\n tile_1  19.196 21.5295 22.3051 22.3316 45.8745\n           4221    8435    5700   10377    6679\n tile_2  6.0239   6.793  7.5396  7.8783  8.1283\n            901    8375    1220   13321    9580\n tile_3  2.8953  2.9166  2.9229  2.9717  3.1414\n            898    2210   10925   11401   13548\n tile_4 12.4816 12.7702 13.2598 14.1528 14.2479\n\n- Weight statistics:\n\n       Coef of Var   MAD Entropy # Zeros\ntile_1       1.805 0.810   0.629       0\ntile_2       0.680 0.405   0.160       0\ntile_3       0.495 0.325   0.101       0\ntile_4       1.535 0.837   0.617       0\n\n- Effective Sample Sizes:\n\n            tile_1  tile_2  tile_3  tile_4\nUnweighted 3608.   3567.   3559.   3596.  \nWeighted    847.47 2438.57 2858.67 1072.08\n```\n\n\n:::\n\n```{.r .cell-code}\n# visualise\nplot(sum_ebal_match_ebal_ate)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\nSome extreme weights.  We can trip weights as follows. (Note there is no hard and fast rule about how much to trim weights by.)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# trimmed weights\nmatch_ebal_ate_trim <- WeightIt::trim(match_ebal_ate, at = .99)\n\n# check balance\n# bal.tab(match_ebal_ate_trim)\n\n# summary\nsummary_match_ebal_ate_trim <- summary(match_ebal_ate_trim)\n\n# check - extreme weights gone\nplot(summary_match_ebal_ate_trim)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/unnamed-chunk-15-1.png){width=1152}\n:::\n\n```{.r .cell-code}\n# plot for balance\nlove.plot(match_ebal_ate_trim, binary = \"std\", thresholds = c(m = .1),\n          wrap = 50, position = \"bottom\", size =2, limits = list(m = c(-.5, .5)))\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/unnamed-chunk-15-2.png){width=1152}\n:::\n:::\n\n\n\n### Estimation\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# here_save(match_ebal_ate_trim, \"match_ebal_ate_trim\")\n# match_ebal_ate_trim <- here_read( \"match_ebal_ate_trim\")\n\n\n# set data frame; output of match_mi_general model\ndf_ate = match_ebal_ate_trim\n\n# remind self of levels if needed\n# levels(mice_health_long$t1_perfectionism_4tile)\n\n# set treatment level\ntreat_0 = \"tile_1\" # lowest quartile\ntreat_1 = \"tile_3\" # third quartile\n\n# bootstrap simulations ( generally use 1000)\nnsims <- 1000\n\n# cores\ncl =  parallel::detectCores () \n\nestimand = \"ATE\"\n\n# as specified\nvcov = \"HC2\" # robust standard errors. \n\n# cores\ncores = parallel::detectCores () # use all course\n\n# Example call to the function\n\n\n# propensity score only model\npropensity_mod_fit_t2_kessler_latent_anxiety_z <-margot::double_robust_marginal(\n  df = df_ate,\n  Y = \"t2_kessler_latent_anxiety_z\",\n  X = X, \n  baseline_vars = 1, # we are not regressing with any covariates\n  treat_1 = treat_1,\n  treat_0 = treat_0,\n  nsims = 1000,\n  cores = cores,\n  family = \"gaussian\",\n  weights = TRUE,\n  continuous_X = FALSE,\n  splines = FALSE,\n  estimand = \"ATE\",\n  type_causal = \"RD\",  \n  type_tab = \"RD\",    \n  vcov = vcov,         \n  new_name = \"Kessler Anxiety (PR)\",\n  delta = 1,\n  sd = 1\n)\n\n# save\nhere_save(propensity_mod_fit_t2_kessler_latent_anxiety_z, \"propensity_mod_fit_t2_kessler_latent_anxiety_z\")\n\npropensity_mod_fit_t2_kessler_latent_depression_z <-margot::double_robust_marginal(\n  df = df_ate,\n  Y = \"t2_kessler_latent_depression_z\",\n  X = X,  \n  baseline_vars = 1, #no covariates, only the propensity scores\n  treat_1 = treat_1,\n  treat_0 = treat_0,\n  nsims = 1000,\n  cores = cores,\n  family = \"gaussian\",\n  weights = TRUE,\n  continuous_X = FALSE,\n  splines = FALSE,\n  estimand = \"ATE\",\n  type_causal = \"RD\",  \n  type_tab = \"RD\",    \n  vcov = vcov,         \n  new_name = \"Kessler Depression (PR)\",\n  delta = 1,\n  sd = 1\n)\n\n# save\nhere_save(propensity_mod_fit_t2_kessler_latent_depression_z, \"propensity_mod_fit_t2_kessler_latent_depression_z\")\n\n\n\n## Doubly robust\nmod_fit_t2_kessler_latent_anxiety_z <-margot::double_robust_marginal(\n  df = df_ate,\n  Y = \"t2_kessler_latent_anxiety_z\",\n  X = X,\n  baseline_vars = baseline_vars_models, # no covariates, only the propensity scores\n  treat_1 = treat_1,\n  treat_0 = treat_0,\n  nsims = 1000,\n  cores = cores,\n  family = \"gaussian\",\n  weights = TRUE,\n  continuous_X = FALSE,\n  splines = FALSE,\n  estimand = \"ATE\",\n  type_causal = \"RD\",  \n  type_tab = \"RD\",    \n  vcov = vcov,         \n  new_name = \"Kessler Anxiety (DR)\",\n  delta = 1,\n  sd = 1\n)\n\n# save\nhere_save(propensity_mod_fit_t2_kessler_latent_anxiety_z, \"propensity_mod_fit_t2_kessler_latent_anxiety_z\")\n\n\n# model 2\nmod_fit_t2_kessler_latent_depression_z <-margot::double_robust_marginal(\n  df = df_ate,\n  Y = \"t2_kessler_latent_depression_z\",\n  X = X,\n  baseline_vars = baseline_vars_models,\n  treat_1 = treat_1,\n  treat_0 = treat_0,\n  nsims = 1000,\n  cores = cores,\n  family = \"gaussian\",\n  weights = TRUE,\n  continuous_X = FALSE,\n  splines = FALSE,\n  estimand = \"ATE\",\n  type_causal = \"RD\",  \n  type_tab = \"RD\",    \n  vcov = vcov,         \n  new_name = \"Kessler Depression (DR)\",\n  delta = 1,\n  sd = 1\n)\n\n# save\nhere_save(mod_fit_t2_kessler_latent_depression_z, \"mod_fit_t2_kessler_latent_depression_z\")\n```\n:::\n\n\n\n\n### Results\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# to save time, we do not run the models\n# recover saved models \n\n# propensity score  models\npropensity_mod_fit_t2_kessler_latent_depression_z<- here_read(\"propensity_mod_fit_t2_kessler_latent_depression_z\")\npropensity_mod_fit_t2_kessler_latent_anxiety_z<- here_read(\"propensity_mod_fit_t2_kessler_latent_anxiety_z\")\n\n# doubly robust models\nmod_fit_t2_kessler_latent_depression_z<- here_read(\"mod_fit_t2_kessler_latent_depression_z\")\nmod_fit_t2_kessler_latent_anxiety_z<- here_read(\"mod_fit_t2_kessler_latent_anxiety_z\")\n\n\n# tables\nlibrary(kableExtra)\n\n# proprensity only \ntab_double_pr <- rbind(propensity_mod_fit_t2_kessler_latent_depression_z$tab_results,\n      propensity_mod_fit_t2_kessler_latent_anxiety_z$tab_results)\n# bind results in a table\ntab_double_robust <- rbind(mod_fit_t2_kessler_latent_depression_z$tab_results,\n      mod_fit_t2_kessler_latent_anxiety_z$tab_results)\n\n\n# combine the individual results\ntab_combo <- rbind(tab_double_pr,tab_double_robust)\n\n\n# table\ntab_combo |> \n  kbl(format = \"markdown\")\n```\n:::\n\n\n\n\nWe see that the doubly robust estimator leads to lower overall effect sizes\n\n\n\n### Subgroup estimation \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# let's take a different approach\n# this time we include the censored variable \n\nexposure_vars <- c(\"perfectionism_4tile\", \"censored\")\nbaseline_vars<-setdiff(baseline_vars, \"sample_weights\")\n\n# here we imput the baseline \ndf_impute_base<- margot_wide_impute_baseline(dat_long, baseline_vars = baseline_vars, \n                                             exposure_var = exposure_vars, outcome_vars = outcome_vars)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n iter imp variable\n  1   1  t0_born_nz  t0_employed  t0_edu  t0_partner  t0_parent  t0_neighbourhood_community  t0_religion_religious  t0_kessler_latent_depression  t0_kessler_latent_anxiety  t0_urban  t0_household_inc_log\n  2   1  t0_born_nz  t0_employed  t0_edu  t0_partner  t0_parent  t0_neighbourhood_community  t0_religion_religious  t0_kessler_latent_depression  t0_kessler_latent_anxiety  t0_urban  t0_household_inc_log\n  3   1  t0_born_nz  t0_employed  t0_edu  t0_partner  t0_parent  t0_neighbourhood_community  t0_religion_religious  t0_kessler_latent_depression  t0_kessler_latent_anxiety  t0_urban  t0_household_inc_log\n  4   1  t0_born_nz  t0_employed  t0_edu  t0_partner  t0_parent  t0_neighbourhood_community  t0_religion_religious  t0_kessler_latent_depression  t0_kessler_latent_anxiety  t0_urban  t0_household_inc_log\n  5   1  t0_born_nz  t0_employed  t0_edu  t0_partner  t0_parent  t0_neighbourhood_community  t0_religion_religious  t0_kessler_latent_depression  t0_kessler_latent_anxiety  t0_urban  t0_household_inc_log\n```\n\n\n:::\n\n```{.r .cell-code}\n# save\n\n# get sample weights\ndt_18 <- dat_long |> filter(wave == 2018)\n\n# add sample weights\ndf_impute_base$t0_sample_weights = dt_18$sample_weights\n\n# save\nhere_save(df_impute_base, \"df_impute_base\")\n```\n:::\n\n\n\n### Wrangling\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_impute_base <- here_read(\"df_impute_base\")\n\n# get correct censoring \nt0_na_condition <-\n  rowSums(is.na(select(df_impute_base, starts_with(\"t1_\")))) > 0\nt1_na_condition <-\n  rowSums(is.na(select(df_impute_base, starts_with(\"t2_\")))) > 0\n\n# tidy your data\ndf_clean <- df_impute_base |>\n  mutate(t0_censored = ifelse(t0_na_condition, 0, t0_censored)) |>\n  mutate(t1_censored = ifelse(t1_na_condition, 0, t1_censored))|>\n  mutate(across(starts_with(\"t1_\"), ~ ifelse(t0_censored == 0, NA_real_, .)),\n         across(starts_with(\"t2_\"), ~ ifelse(t0_censored == 0, NA_real_, .))) |>\n  mutate(across(starts_with(\"t2_\"), ~ ifelse(t1_censored == 0, NA_real_, .))) |>\n  # select variables\n  dplyr::mutate(\n    across(\n      .cols = where(is.numeric) &\n        !t0_censored &\n        !t0_sample_weights & \n        !t0_alert_level_combined_lead &\n        !t1_perfectionism_4tile &\n        !t1_censored,\n      .fns = ~ scale(.),\n      .names = \"{.col}_z\"\n    )\n  ) |>\n  # select(-t0_charity_donate,\n  #        -t0_hours_charity) |>\n  select(\n    where(is.factor),\n    t0_sample_weights,\n    t0_alert_level_combined_lead,\n    t0_sample_weights,\n    t0_censored,\n    t1_perfectionism_4tile,\n    t1_censored,\n    ends_with(\"_z\")\n  ) |>\n  mutate(t0_lost = 1 - t1_censored) |> \n  mutate(t1_lost = 1 - t1_censored) |> \n  mutate(t1_perfectionism_4tile = factor(t1_perfectionism_4tile, ordered = TRUE, labels = c(\"tile_1\", \"tile_2\", \"tile_3\", \"tile_4\")) )|> \n  relocate(starts_with(\"t0_\"), .before = starts_with(\"t1_\")) |> # make a factor\n  relocate(\"t0_censored\", .before = starts_with(\"t1_\"))  |>\n  relocate(\"t1_censored\", .before = starts_with(\"t2_\")) \n\n\n\n# we'll have a variable for \"lost\" \n# this is the usual meaning of \"censored\"\ntable(df_clean$t1_lost)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n    0     1 \n11469  2861 \n```\n\n\n:::\n\n```{.r .cell-code}\ntable(df_clean$t1_censored)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n    0     1 \n 2861 11469 \n```\n\n\n:::\n\n```{.r .cell-code}\nstr(df_clean$t1_perfectionism_4tile)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Ord.factor w/ 4 levels \"tile_1\"<\"tile_2\"<..: 3 3 4 2 4 3 3 1 1 2 ...\n```\n\n\n:::\n\n```{.r .cell-code}\n# \n# df_impute_base$t1_perfectionism_z = scale(df_impute_base$t1_perfectionism)\n\n# get rid of attributes\ndf_clean <- margot::remove_numeric_attributes(df_clean)\n\n\n# censoring ---------------------------------------------------------------\nbaseline_vars_models = df_clean |>  # post process of impute and combine\n  dplyr::select(starts_with(\"t0\"), - t0_alert_level_combined_lead,-t0_censored, -t0_lost, -t0_sample_weights)|> colnames() # note, we ear\n\nbaseline_vars_models\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"t0_eth_cat\"                     \"t0_perfectionism_4tile\"        \n [3] \"t0_age_z\"                       \"t0_male_z\"                     \n [5] \"t0_edu_z\"                       \"t0_partner_z\"                  \n [7] \"t0_employed_z\"                  \"t0_born_nz_z\"                  \n [9] \"t0_neighbourhood_community_z\"   \"t0_household_inc_log_z\"        \n[11] \"t0_parent_z\"                    \"t0_religion_religious_z\"       \n[13] \"t0_urban_z\"                     \"t0_kessler_latent_anxiety_z\"   \n[15] \"t0_kessler_latent_depression_z\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# fit proponsity score model \nmatch_censoring <- margot::match_mi_general(data = df_clean, \n                                      X = \"t1_lost\", \n                                      baseline_vars = baseline_vars_models, \n                                      estimand = \"ATE\",  \n                                      # focal = \"< >\", for ATT\n                                      method = \"cbps\", \n                                      sample_weights = \"sample_weights\")\n\n# save output\nhere_save( match_censoring, \"match_censoring\") \n```\n:::\n\n\n### Matching\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read output\nmatch_censoring <- margot::here_read(\"match_censoring\")\n# check balance\n# bal.tab(match_censoring)\n\n# visualise imbalance\nlove.plot(match_censoring, binary = \"std\", thresholds = c(m = .1),\n          wrap = 50, position = \"bottom\", size =3)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/vis_matching_censoring-1.png){width=1152}\n:::\n:::\n\n\n\n### Subgroup analysis \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get censoring weights\nlost_prob <- match_censoring$weights\n\n# check\nsummary(lost_prob)\n\n# rename sample weights # multiply censoring weights by sample weights \ndf_clean$sample_weights <- (match_censoring$weights * df_clean$t0_sample_weights)\n\nsummary(df_clean$sample_weights )\n\n# next filter only those who were not lost\ndf_clean_filtered<- df_clean |> \n  filter(t1_censored == 1)\n\ndf_clean_filtered <- df_clean_filtered |>\n  relocate(\"sample_weights\", .before = starts_with(\"t0_\")) |>\n  relocate(starts_with(\"t0_\"), .before = starts_with(\"t1_\")) |>\n  relocate(\"t0_censored\", .before = starts_with(\"t1_\"))  |>\n  relocate(\"t1_censored\", .before = starts_with(\"t2_\"))\n\n\nnrow(df_clean_filtered)\n\nhist(df_clean_filtered$sample_weights)\n\n# next propensity scores by groups \n\nlevels(df_clean_filtered$t0_eth_cat)\nlevels(df_clean_filtered$t1_perfectionism_4tile)\n# \n\ndf_subgroup <-df_clean_filtered |> filter(t0_eth_cat == \"maori\" | t0_eth_cat == \"euro\") |> droplevels()\n\n# save\nhere_save(df_subgroup, \"df_subgroup\")\n\n# check\ntable(df_subgroup$t0_eth_cat)\n\nbaseline_vars_models_sans_eth <- setdiff(baseline_vars_models, \"t0_eth_cat\")\n\n# save\nhere_save(baseline_vars_models_sans_eth, \"baseline_vars_models_sans_eth\")\n\n## \nstring <- formula_str <- as.formula(paste(\"t1_perfectionism_4tile\", \"~\", paste(baseline_vars_models, collapse = \"+\")))\n\nstring_sans <- formula_str <- as.formula(paste(\"t1_perfectionism_4tile\", \"~\", paste(baseline_vars_models_sans_eth, collapse = \"+\")))\n\nW1 <- weightit(\n  string,\n  method = \"ipt\",\n  estimand = \"ATT\",\n  weights = \"sample_weights\",\n  focal = \"tile_3\",\n  # super = TRUE,\n  #SL.library = c(\"SL.ranger\", \"SL.glmnet\", \"SL.polymars\", \"SL.xgboost\"),\n  #super = TRUE,\n  data = df_subgroup\n)\nsummary(W1)\n\n# save model\nhere_save(W1, \"W1\")\n\nW2 <- weightit(\n  string_sans,\n  method = \"ipt\",\n  estimand = \"ATT\",\n  weights = \"sample_weights\",\n  by = \"t0_eth_cat\",\n  weights = \"sample_weights\",\n  focal = \"tile_3\",\n#  super = TRUE,\n#  SL.library = c(\"SL.ranger\", \"SL.glmnet\", \"SL.polymars\", \"SL.xgboost\"),\n  data = df_subgroup\n)\n\nsummary(W2)\n\n# save model\nhere_save(W2, \"W2\")\n\n# test diff\n\n#S <- sbps(W1, W2)\n# warnings()\n# S\n```\n:::\n\n\n\n### Wvaluate subgroup weighting model\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nW1 <- here_read(\"W1\")\nW2 <- here_read(\"W2\")\n\n# read\ndf_subgroup <- margot::here_read(\"df_subgroup\")\n\n# bal.tab(W1, un = TRUE)\nlove.plot(W1, binary = \"std\", thresholds = c(m = .1),\n          wrap = 50, position = \"bottom\", size =2)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/unnamed-chunk-22-1.png){width=1152}\n:::\n\n```{.r .cell-code}\n# this method has better effective samples\n# bal.tab(W1)\n\n\n# this method has better balance\n# bal.tab(W2, cluster = \"t0_eth_cat\")\n# bal.tab(W1, cluster = \"t0_eth_cat\")\n# graph by cluster\nlove.plot(W1,  cluster = \"t0_eth_cat\", binary = \"std\", thresholds = c(m = .1),\n          wrap = 50, position = \"bottom\", size =2)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/unnamed-chunk-22-2.png){width=1152}\n:::\n:::\n\n\n\n\n### Parametric estimation of subgroup model\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# prepare data\n\n# read vars\nbaseline_vars_models_sans_eth <- margot::here_read(\"baseline_vars_models_sans_eth\")\n\n# make combo weights\ndf_subgroup$combo_weights = W2$weights * df_subgroup$t0_sample_weights\n\n\n# set dataframe\ndf = df_subgroup\n\n### SUBGROUP analysis\nY_anxiety = \"t2_kessler_latent_anxiety_z\"\nY_depression = \"t2_kessler_latent_depression_z\"\n\nX = \"t1_perfectionism_4tile\"\n\ntreat_0 = \"tile_1\"\ntreat_1 = \"tile_3\"\nestimand = \"ATT\"\nscale = \"RD\"\nnsims = 1000\nfamily = \"gaussian\"\ncontinuous_X = FALSE\nsplines = FALSE\ncores = parallel::detectCores()\nS = \"t0_eth_cat\"\n\n# not we interact the subclass X treatment X covariates\n\nformula_str_anxiety <-\n  paste(\n    Y_anxiety,\n    \"~\",\n    S,\n    \"*\",\n    \"(\",\n    X ,\n    \"*\",\n    \"(\",\n    paste(baseline_vars_models_sans_eth, collapse = \"+\"),\n    \")\",\n    \")\"\n  )\n\nformula_str_depression <-\n  paste(\n    Y_depression,\n    \"~\",\n    S,\n    \"*\",\n    \"(\",\n    X ,\n    \"*\",\n    \"(\",\n    paste(baseline_vars_models_sans_eth, collapse = \"+\"),\n    \")\",\n    \")\"\n  )\n\nformula_str_anxiety\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"t2_kessler_latent_anxiety_z ~ t0_eth_cat * ( t1_perfectionism_4tile * ( t0_perfectionism_4tile+t0_age_z+t0_male_z+t0_edu_z+t0_partner_z+t0_employed_z+t0_born_nz_z+t0_neighbourhood_community_z+t0_household_inc_log_z+t0_parent_z+t0_religion_religious_z+t0_urban_z+t0_kessler_latent_anxiety_z+t0_kessler_latent_depression_z ) )\"\n```\n\n\n:::\n\n```{.r .cell-code}\nformula_str_depression\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"t2_kessler_latent_depression_z ~ t0_eth_cat * ( t1_perfectionism_4tile * ( t0_perfectionism_4tile+t0_age_z+t0_male_z+t0_edu_z+t0_partner_z+t0_employed_z+t0_born_nz_z+t0_neighbourhood_community_z+t0_household_inc_log_z+t0_parent_z+t0_religion_religious_z+t0_urban_z+t0_kessler_latent_anxiety_z+t0_kessler_latent_depression_z ) )\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# fit model\nfit_all_all_anxiety  <- glm(\n  as.formula(formula_str_anxiety),\n  weights = combo_weights,\n  # weights = if (!is.null(weight_var)) weight_var else NULL,\n  family = family,\n  data = df\n)\n\n#summary(fit_all_all_anxiety)\n\nfit_all_all_depression  <- glm(\n  as.formula(formula_str_depression),\n  weights = combo_weights,\n  # weights = if (!is.null(weight_var)) weight_var else NULL,\n  family = family,\n  data = df\n)\n\n\n# coefs <- coef(fit_all_all_anxiety)\n# table(is.na(coefs))#     t0_eth_catmāori:t1_perfectionism_coarsen.Q:t0_gen_cohort.C\n\n# #FALSE  TRUE\n# 344     4\n# \n# insight::get_varcov(fit_all_all_anxiety)\n```\n:::\n\n\n\n### Subgroup Results \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# simulate coefficients\nsim_model_all <- sim(fit_all_all_anxiety, n = nsims, vcov = \"HC2\")\n\n\n# simulate effect as modified in europeans\nsim_estimand_all <- sim_ame(\n  sim_model_all,\n  var = X,\n  cl = cores,\n  by = \"t0_eth_cat\",\n  verbose = FALSE\n)\n\n# summary(sim_estimand_all)\n\n# make table\nsim_estimand_all_tab <-\n  transform(sim_estimand_all, RD_euro = `E[Y(tile_3)|euro]` - `E[Y(tile_1)|euro]`,\n            RD_maori =  `E[Y(tile_3)|maori]` - `E[Y(tile_1)|maori]`,\n            gamma_hat = (`E[Y(tile_3)|euro]` - `E[Y(tile_1)|euro]`) - (`E[Y(tile_3)|maori]` - `E[Y(tile_1)|maori]`))\n\nsim_estimand_all_tab\n# save table\nhere_save(sim_estimand_all_tab, \"sim_estimand_all_tab\")\n```\n:::\n\n\n\nSummary of model\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read table\nsim_estimand_all_tab <- margot::here_read(\"sim_estimand_all_tab\")\n\n# print table\nsummary(sim_estimand_all_tab)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                   Estimate    2.5 %   97.5 %\nE[Y(tile_1)|euro]  -0.22769 -0.29766 -0.16196\nE[Y(tile_2)|euro]  -0.12778 -0.17979 -0.07416\nE[Y(tile_3)|euro]   0.04378 -0.00469  0.08749\nE[Y(tile_4)|euro]   0.20959  0.12602  0.29064\nE[Y(tile_1)|maori] -0.14605 -0.31690  0.01945\nE[Y(tile_2)|maori] -0.12832 -0.28071  0.01619\nE[Y(tile_3)|maori] -0.06828 -0.20076  0.06498\nE[Y(tile_4)|maori]  0.32930  0.16028  0.49872\nRD_euro             0.27146  0.19125  0.35447\nRD_maori            0.07777 -0.13736  0.29367\ngamma_hat           0.19369 -0.04480  0.41896\n```\n\n\n:::\n:::\n\n\n\n\n### Machine learning estimation: subgroups\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# lmtp\nlibrary(\"lmtp\")\n\n# set number of folds for ML here. use a minimum of 5 and a max of 10\nSL_folds = 10\n\n#this will allow you to track progress\nprogressr::handlers(global = TRUE)\n\n# set seed for reproducing results\nset.seed(0112358)\n\n# set cores for estimation\nlibrary(future)\nplan(multisession)\nn_cores <- parallel::detectCores() - 2 # save two cores for other work while these models run\n\n# min of 10\nn_cores\n\n# super learner libraries\n# these are useful for high-dimensional data\nsl_lib <- c(\"SL.glmnet\",\n            \"SL.ranger\", # forests\n            \"SL.xgboost\") # grandient boost\n\n\ndf_maori <-df_clean_filtered |> filter(t0_eth_cat == \"maori\") |> select( -t0_lost, -t1_lost) |> droplevels()\ndf_euro <-df_clean_filtered |> filter(t0_eth_cat == \"euro\") |> select( -t0_lost, -t1_lost) |> droplevels()\nnrow(df_maori)\nnrow(df_euro)\n\ncolnames(df_clean_filtered)\n\nA<- \"t1_perfectionism_4tile\"\n\n# note lmtp's unconventional use of \"censored\"\nC <- c(\"t1_censored\")\n\ndf_clean_filtered$sample_weights\n\nnames_base <-\n  df_clean_filtered |> select(starts_with(\"t0\"),\n                     -t0_sample_weights, \n                     -t0_censored,\n                     -t0_lost,\n                     -t0_eth_cat) |> colnames()\n\nC <- c(\"t1_censored\")\n\n\nshift_all_tile_3 <- function(data, trt) {\n  ifelse(data[[trt]] != \"tile_3\", \"tile_3\",  data[[trt]])\n}\nglimpse(df_maori)\n\n\nshift_all_tile_1 <- function(data, trt) {\n  ifelse(data[[trt]] != \"tile_1\", \"tile_1\",  data[[trt]])\n}\n\n\n## no parametric estimation \nmaori_tile_3_t2_kessler_latent_anxiety_z <- lmtp_tmle(\n    data = df_maori,\n    trt = A,\n    baseline = names_base,\n    outcome = \"t2_kessler_latent_anxiety_z\",\n    cens = C,\n    shift = shift_all_tile_3,\n    mtp = TRUE,\n    folds = 10,\n    # trim = 0.99, # if needed\n    # time_vary = NULL,\n    outcome_type = \"continuous\",\n    weights = df_maori$sample_weights,\n    learners_trt = \"SL.ranger\",\n    learners_outcome =\"SL.ranger\",\n    parallel = n_cores\n  )\nmaori_tile_3_t2_kessler_latent_anxiety_z\nhere_save(maori_tile_3_t2_kessler_latent_anxiety_z, \"maori_tile_3_t2_kessler_latent_anxiety_z\")\n\n\nmaori_tile_1_t2_kessler_latent_anxiety_z <- lmtp_tmle(\n    data = df_maori,\n    trt = A,\n    baseline = names_base,\n    outcome = \"t2_kessler_latent_anxiety_z\",\n    cens = C,\n    shift = shift_all_tile_1,\n    mtp = TRUE,\n    folds = 10,\n    # trim = 0.99, # if needed\n    # time_vary = NULL,\n    outcome_type = \"continuous\",\n    weights = df_maori$sample_weights,\n    learners_trt = \"SL.ranger\",\n    learners_outcome =\"SL.ranger\",\n    parallel = n_cores\n  )\nmaori_tile_1_t2_kessler_latent_anxiety_z\nhere_save(maori_tile_1_t2_kessler_latent_anxiety_z, \"maori_tile_1_t2_kessler_latent_anxiety_z\")\n\n# higher anxiety \nmaori_results <-lmtp_contrast(maori_tile_3_t2_kessler_latent_anxiety_z, ref = maori_tile_1_t2_kessler_latent_anxiety_z)\n\nhere_save(maori_results, \"maori_results\")\n\neuro_tile_3_t2_kessler_latent_anxiety_z <- lmtp_tmle(\n    data = df_euro,\n    trt = A,\n    baseline = names_base,\n    outcome = \"t2_kessler_latent_anxiety_z\",\n    cens = C,\n    shift = shift_all_tile_3,\n    mtp = TRUE,\n    folds = 10,\n    # trim = 0.99, # if needed\n    # time_vary = NULL,\n    outcome_type = \"continuous\",\n    weights = df_euro$sample_weights,\n    learners_trt = \"SL.ranger\",\n    learners_outcome =\"SL.ranger\",\n    parallel = n_cores\n  )\neuro_tile_3_t2_kessler_latent_anxiety_z\nhere_save(euro_tile_3_t2_kessler_latent_anxiety_z, \"euro_tile_3_t2_kessler_latent_anxiety_z\")\n\n\neuro_tile_1_t2_kessler_latent_anxiety_z <- lmtp_tmle(\n    data = df_euro,\n    trt = A,\n    baseline = names_base,\n    outcome = \"t2_kessler_latent_anxiety_z\",\n    cens = C,\n    shift = shift_all_tile_1,\n    mtp = TRUE,\n    folds = 10,\n    # trim = 0.99, # if needed\n    # time_vary = NULL,\n    outcome_type = \"continuous\",\n    weights = df_euro$sample_weights,\n    learners_trt = \"SL.ranger\",\n    learners_outcome =\"SL.ranger\",\n    parallel = n_cores\n  )\neuro_tile_1_t2_kessler_latent_anxiety_z\nhere_save(euro_tile_1_t2_kessler_latent_anxiety_z, \"euro_tile_1_t2_kessler_latent_anxiety_z\")\n\n\neuro_results <- lmtp_contrast(euro_tile_3_t2_kessler_latent_anxiety_z, ref = euro_tile_1_t2_kessler_latent_anxiety_z)\nhere_save(euro_results, \"euro_results\")\n```\n:::\n\n\n\n\n### Machine learning results\n\nNo difference between groups. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\neuro_results <- margot::here_read(\"euro_results\")\nmaori_results<- margot::here_read(\"maori_results\")\n\ng_hat_theta= euro_results$vals$theta - maori_results$vals$theta \ng_hat_theta # difference of means\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.003747137\n```\n\n\n:::\n\n```{.r .cell-code}\neuro_results$vals$std.error\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.02212442\n```\n\n\n:::\n\n```{.r .cell-code}\n# difference \nse_diff = sqrt( (euro_results$vals$std.error^2) + (maori_results$vals$std.error^2) )\n\ndiff_conf.low = g_hat_theta - (1.97 * se_diff)\ndiff_conf.high = g_hat_theta + (1.97 * se_diff)\n\n\ng_hat_anxiety <- cbind.data.frame(g_hat_theta, se_diff, diff_conf.low, diff_conf.high)\n\n# result\ng_hat_anxiety\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  g_hat_theta    se_diff diff_conf.low diff_conf.high\n1 0.003747137 0.05990591    -0.1142675      0.1217618\n```\n\n\n:::\n:::\n\n\n\n\nNote, however that the invevention increases anxiety for both groups equally\n\n\n### Europeans results\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\neuro_results <- margot::here_read(\"euro_results\")\nround( euro_results$vals, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  theta shift    ref std.error conf.low conf.high p.value\n1 0.189 0.067 -0.122     0.022    0.146     0.232       0\n```\n\n\n:::\n:::\n\n\n\n\n### Maori results\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaori_results<- margot::here_read(\"maori_results\")\nround(maori_results$vals, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  theta shift    ref std.error conf.low conf.high p.value\n1 0.185  0.07 -0.115     0.056    0.076     0.294   0.001\n```\n\n\n:::\n:::\n\n\n\n\n### Graph results\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntab_euro_results <- margot::margot_lmtp_evalue(\n  euro_results,\n  scale = \"RD\",\n  new_name = \"Euro: 1_tile to 3_tile\"\n)\n\n\n\ntab_maori_results <- margot::margot_lmtp_evalue(\n  maori_results,\n  scale = \"RD\",\n  new_name = \"Māori: 1_tile to 3_tile\"\n)\n\nbind_results_anxiety <- rbind(tab_euro_results, tab_maori_results)\n\nhere_save(bind_results_anxiety, \"bind_results_anxiety\")\n\ngroup_tab_anxiety <- margot::group_tab(bind_results_anxiety, type = \"RD\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# graph results\n margot_plot(\n  group_tab_anxiety,\n  type = \"RD\",\n  title = \"Perfectionism: shift all to 3_tile, contrast with 1_tile\",\n  subtitle = \"Outcome = Anxiety\",\n  estimate_scale = 1,\n  base_size = 18,\n  text_size = 4.5,\n  point_size = 3.5,\n  title_size = 20,\n  subtitle_size = 16,\n  legend_text_size = 10,\n  legend_title_size = 10,\n  x_offset = -.5,\n  x_lim_lo = -.5,\n  x_lim_hi =  .5\n)\n```\n\n::: {.cell-output-display}\n![](08-content_files/figure-html/unnamed-chunk-31-1.png){width=960}\n:::\n:::\n\n\n\n\nInterpret Results\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmargot_interpret_table(group_tab_anxiety, estimand = \"ATT\", causal_scale = \"causal_difference\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nThe Average Treatment Effect on the Treated (ATT) assesses the expected outcome difference for those receiving the treatment, compared to a similar group that did not, within the target population.\n\nFor 'Euro: 1_tile to 3_tile', the effect estimate is 0.189 [0.146, 0.232]. The E-value for this estimate is 1.66, with a lower bound of 1.545. At this lower bound, unmeasured confounders would need a minimum association strength with both the intervention sequence and outcome of 1.545 to negate the observed effect. Weaker confounding would not overturn it. We infer **evidence for causality**.\n\nFor 'Māori: 1_tile to 3_tile', the effect estimate is 0.185 [0.076, 0.294]. The E-value for this estimate is 1.649, with a lower bound of 1.347. At this lower bound, unmeasured confounders would need a minimum association strength with both the intervention sequence and outcome of 1.347 to negate the observed effect. Weaker confounding would not overturn it. We infer **evidence for causality**.\n```\n\n\n:::\n:::\n\n\n\n\n## Take Home Message\n\nMachine learning with cross validation recovers nearly identical estimates for the effect of a shift in perfectionism on anxiety among Māori and Europeans. \n\nWhich results are correct?  We don't know. With more time, we would add more learners to the model, including parametric learners. \n\n\nGenerally I suggest using machine learning algorithms, because they can include parametric estimators. \n\n\n\n\n",
    "supporting": [
      "08-content_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}